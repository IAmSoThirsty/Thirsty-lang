/**
 * Thirsty-lang Documentation Generator
 * Generate beautiful docs from your code!
 */

const fs = require('fs');
const path = require('path');

class ThirstyDocGenerator {
  constructor() {
    this.functions = [];
    this.variables = [];
    this.comments = [];
  }

  parse(code) {
    const lines = code.split('\n');
    let currentComment = [];

    lines.forEach((line, index) => {
      const trimmed = line.trim();

      // Collect comments
      if (trimmed.startsWith('//')) {
        currentComment.push(trimmed.substring(2).trim());
      } else if (trimmed) {
        // Process statement with accumulated comments
        if (trimmed.startsWith('drink ')) {
          const match = trimmed.match(/drink\s+(\w+)\s*=\s*(.+)/);
          if (match) {
            this.variables.push({
              name: match[1],
              value: match[2],
              comment: currentComment.join(' '),
              line: index + 1
            });
          }
        }
        
        currentComment = [];
      }
    });
  }

  generateMarkdown() {
    let md = '# Code Documentation\n\n';
    md += '_Auto-generated documentation for Thirsty-lang code_\n\n';
    md += '---\n\n';

    if (this.variables.length > 0) {
      md += '## Variables\n\n';
      
      this.variables.forEach(v => {
        md += `### \`${v.name}\`\n\n`;
        if (v.comment) {
          md += `${v.comment}\n\n`;
        }
        md += `**Initial Value:** \`${v.value}\`\n\n`;
        md += `**Defined at:** Line ${v.line}\n\n`;
        md += '---\n\n';
      });
    }

    return md;
  }

  generateHTML() {
    let html = `<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Thirsty-lang Documentation</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 900px;
            margin: 0 auto;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: #333;
        }
        .container {
            background: white;
            padding: 40px;
            border-radius: 10px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }
        h1 {
            color: #667eea;
            border-bottom: 3px solid #667eea;
            padding-bottom: 10px;
        }
        h2 {
            color: #764ba2;
            margin-top: 30px;
        }
        .variable {
            background: #f8f9fa;
            padding: 15px;
            margin: 15px 0;
            border-left: 4px solid #667eea;
            border-radius: 5px;
        }
        .variable-name {
            font-size: 1.2em;
            font-weight: bold;
            color: #667eea;
        }
        code {
            background: #e9ecef;
            padding: 2px 6px;
            border-radius: 3px;
            font-family: 'Courier New', monospace;
        }
        .footer {
            text-align: center;
            margin-top: 40px;
            color: #6c757d;
            font-size: 0.9em;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ðŸ’§ Thirsty-lang Documentation</h1>
        <p><em>Auto-generated documentation</em></p>
`;

    if (this.variables.length > 0) {
      html += '        <h2>Variables</h2>\n';
      
      this.variables.forEach(v => {
        html += `        <div class="variable">\n`;
        html += `            <div class="variable-name">${v.name}</div>\n`;
        if (v.comment) {
          html += `            <p>${v.comment}</p>\n`;
        }
        html += `            <p><strong>Initial Value:</strong> <code>${v.value}</code></p>\n`;
        html += `            <p><strong>Defined at:</strong> Line ${v.line}</p>\n`;
        html += `        </div>\n`;
      });
    }

    html += `        <div class="footer">
            <p>Generated by Thirsty-lang Doc Generator ðŸ’§</p>
            <p>Stay hydrated and keep coding!</p>
        </div>
    </div>
</body>
</html>`;

    return html;
  }

  generate(inputFile, outputDir = 'docs') {
    const code = fs.readFileSync(inputFile, 'utf-8');
    this.parse(code);

    if (!fs.existsSync(outputDir)) {
      fs.mkdirSync(outputDir, { recursive: true });
    }

    // Generate Markdown
    const markdown = this.generateMarkdown();
    const mdPath = path.join(outputDir, 'API.md');
    fs.writeFileSync(mdPath, markdown);
    console.log(`âœ“ Generated ${mdPath}`);

    // Generate HTML
    const html = this.generateHTML();
    const htmlPath = path.join(outputDir, 'index.html');
    fs.writeFileSync(htmlPath, html);
    console.log(`âœ“ Generated ${htmlPath}`);

    console.log('\nðŸ“š Documentation generated successfully!');
    console.log(`   Open ${htmlPath} in your browser to view`);
  }
}

function main() {
  const args = process.argv.slice(2);

  if (args.length === 0) {
    console.log('Thirsty-lang Documentation Generator');
    console.log('Usage: node src/doc-generator.js <file.thirsty> [output-dir]');
    console.log('\nGenerates both Markdown and HTML documentation');
    process.exit(0);
  }

  const inputFile = args[0];
  const outputDir = args[1] || 'docs/generated';

  if (!fs.existsSync(inputFile)) {
    console.error(`Error: File '${inputFile}' not found`);
    process.exit(1);
  }

  const generator = new ThirstyDocGenerator();
  generator.generate(inputFile, outputDir);
}

if (require.main === module) {
  main();
}

module.exports = ThirstyDocGenerator;
